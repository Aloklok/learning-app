### **日语学习桌面应用 - 项目总结与开发者文档 (已更新)**

#### **1. 项目愿景 (Project Vision)**

本项目旨在打造一款**以学习者为中心、本地化、沉浸式**的日语学习桌面应用。它摒弃了传统在线平台的账号和网络依赖，将所有学习数据和进度掌握在用户自己手中。应用以"**首页即学习**"为核心理念，通过动态内容解锁和即时状态反馈，为用户提供一个高效、专注且充满成就感的个人学习环境。

-----

#### **2. 功能总览 (App Functionality)**

##### **核心学习功能**

  * **首页即学习**: 应用启动后，直接展示当前应学课程的完整内容，无需任何多余点击。
  * **课程内导航**: 在学习页面顶部，提供相邻课程的快速切换按钮，方便用户在上下课之间预览和跳转。
  * **多模块学习内容**: 每节课都包含**情景对话、新单词、语法知识点、应用课文、有趣小知识**等多个学习区块。
  * **交互式语音系统**:
      * **全文朗读**: 每个课文模块都提供"朗读全文"功能。
      * **点击朗读**: 对话气泡和单词卡片支持整块点击朗读。
      * **悬浮高亮**: 鼠标悬浮在课文句子或单词卡片上时，会提供高亮和动画反馈。
      * **发音练习**: 基于原生 macOS 模块的语音识别功能（当前为演示模式），支持发音准确度评估和实时反馈。
  * **日文注音 (Furigana)**: 所有日文内容（包括对话、单词、文章）都能正确显示 `汉字[假名]` 格式的注音。

##### **进度与状态管理**

  * **记忆曲线**: 单词和语法都引入了基于"陌生/熟悉/掌握"三阶段的记忆曲线系统，通过星级评分进行标记。
  * **动态内容解锁**: 完成一节课后，系统会自动解锁下一课，营造"闯关"式的学习体验。
  * **全局状态同步**: 基于 `Zustand` 的轻量级全局状态管理，在学习页面更新掌握度或完成课程时，仪表盘的统计数据会**实时、精准**地更新，而无需刷新整个页面。

##### **智能化与辅助功能**

  * **全局AI助手**: 在应用界面的右下角，提供一个全局悬浮的AI助手按钮。
  * **模态框交互**: 点击AI按钮后，会以模态框的形式弹出AI对话界面，用户可以在任何页面随时进行提问，而不打断当前学习流程。
  * **命令行集成**: AI助手通过调用本地安装的 `gemini-cli` 来实现，并支持自定义模型参数。
  * **智能提醒系统**: 集成SmartReminder组件，提供学习和复习提醒功能，支持优先级分类和智能调度。

-----

#### **3. 技术栈 (Technology Stack)**

| 类别 | 技术选型 | 作用与理由 |
| :--- | :--- | :--- |
| **核心框架** | **Electron** | 将Web应用打包为原生桌面App，赋予其访问本地文件系统和执行命令行的能力。 |
| **前端视图** | **React (TypeScript)** | 构建用户界面的核心，TypeScript提供类型安全，保证代码健壮性。 |
| **构建工具** | **Vite** | 提供极速的开发服务器和高效的打包能力。 |
| **UI组件库** | **MUI (Material-UI)** | 提供高质量、丰富的基础UI组件。 |
| **前端路由** | **React Router (`HashRouter`)** | **(新增)** 使用 `HashRouter` 替代 `BrowserRouter`，以完美兼容 Electron 的 `file://` 协议，解决生产环境下的路由匹配问题。 |
| **UI设计系统** | **自定义主题系统** | 基于MUI主题系统构建的完整设计体系，位于`src/theme/`目录，包含调色板、组件样式覆盖、设计系统常量等，为应用提供统一的视觉语言。 |
| **动画库** | **Framer Motion** | 为UI元素提供流畅、声明式的动画效果，提升用户体验。 |
| **包管理器** | **NPM** | **(新增)** Node.js 官方包管理器。用于替代 pnpm，以解决在特定 macOS 环境下依赖安装和脚本执行的稳定性问题。 |
| **打包工具** | **`electron-builder`** | **(新增)** 专业的 Electron 应用打包工具，负责将编译后的代码和依赖项打包成可分发的原生应用（如 `.dmg`）。 |
| **本地数据库** | **SQLite + `better-sqlite3`** | 零配置、高性能的本地数据库，用于存储所有学习内容和用户数据。 |
| **全局状态管理**| **Zustand** | 轻量级的全局状态管理器，用于实现仪表盘和学习页面之间的跨组件状态同步。 |
| **路径别名** | **`vite-tsconfig-paths`** | Vite插件，自动读取 `tsconfig.json` 中的路径别名，实现配置的单一来源。 |
| **语音识别** | **原生 macOS 模块 (speech_recognizer.node)** | (已更新) 基于 Swift 和 N-API 的原生模块，通过 Electron 的 systemPreferences API 请求权限，并实现了健壮的生命周期管理，确保在 dev 和 build 模式下都能稳定运行。 |
| **图表库** | **react-minimal-pie-chart** | 用于在仪表盘上绘制轻量、美观的饼图/甜甜圈图。 |
| **类型定义** | **全局 `models.ts`** | 统一管理所有共享的TypeScript接口，提升代码可维护性和类型安全。 |

-----

#### **4. 数据库设计与数据流 (已优化)**

##### **数据库 Schema (`database/schema.sql`)**

  * **`books`**: 存储教材信息 (如《标准日本语》)。
  * **`lessons`**: 存储课程信息，与 `books` 关联。
  * **`master_vocabulary`**: **中央词库**。存储所有独一无二的单词及其记忆曲线状态。
  * **`lesson_vocabulary_link`**: 关联表，记录哪一课包含了哪个单词。
  * **`grammar`**: 存储所有语法点及其记忆曲线状态。
  * **`texts`**: 存储课文内容，通过 `type` 字段区分"基础课文"和"应用课文"。
  * **`articles`**: 存储"有趣小知识"等泛读材料。
  * **`user_progress`**: 记录用户的学习进度，如哪一课"已解锁"或"已完成"。

##### **核心数据流与IPC通信 (已优化)**

1.  **应用启动**: `main.ts` 检查并按需初始化数据库。
2.  **IPC处理器模块化**: 所有数据库相关的IPC处理器已从 `main.ts` 抽离至 `electron/ipc/database.ts`，由主进程统一注册，实现了后端逻辑的模块化。
3.  **批量更新优化**:创建了一个新的 `db:batchUpdateReviewItems` 接口。前端现在会将所有需要更新的复习项打包成一个数组，通过一次IPC调用发送给主进程。主进程在**数据库事务**中执行所有更新，保证了操作的高效性和原子性。
4.  **单向数据流**:已移除所有前端的状态修改逻辑。现在的数据流严格遵循**单向原则**：
          * **写操作**: 前端组件调用 `window.db` 的接口，将修改请求发送到主进程，直接写入数据库。
          * **读操作/UI同步**: 操作完成后，调用对应 Zustand store 的 `fetch...` 方法 (如 `fetchStats`)，从数据库重新获取最新、最准确的数据，然后更新全局状态，最后由React将新状态渲染到UI。这确保了数据库是唯一可信的数据源。

-----

#### **5. 开发目录结构**

```
learning-app/
├── database/
│   └── schema.sql          # 数据库表结构定义文件
├── electron/
│   ├── ipc/
│   │   └── database.ts     # (新增) 数据库相关的IPC处理器模块
│   ├── main.ts             # Electron 主进程，负责窗口管理和IPC注册
│   └── preload.ts          # Electron 预加载脚本，前后端通信的"桥梁"
├── public/
├── src/
│   ├── assets/             # 静态资源
│   ├── components/         # 您自己的、可复用的UI组件 (WordCard, TextReader, SpeechRecognition等)
│   ├── hooks/              # 自定义 Hooks (useAppTheme.ts, useDatabase.ts)
│   ├── layouts/            # 布局组件 (MainLayout.tsx)
│   ├── pages/              # 页面级组件
│   ├── store/              # 全局状态管理 (Zustand)
│   ├── theme/              # 主题系统 (palette.ts, components.ts, ThemeProvider.tsx等)
│   ├── types/              # 全局类型定义
│   └── utils/              # 工具函数 (furigana.tsx)
├── package.json
├── tsconfig.json           # TS 解决方案根配置
├── tsconfig.app.json       # TS 前端应用配置 (包含路径别名)
├── tsconfig.node.json      # TS Electron主进程配置
├── .npmrc                  # (新增) NPM 配置文件，用于指定 Electron 镜像和 Python 路径
└── vite.config.ts          # Vite 配置文件 (已简化)
```

-----

6. 核心配置与规范 (重要更新)
为了解决开发过程中遇到的各类配置和服务冲突问题，我们建立了一套清晰、健壮的配置规范。
Node.js 版本管理:
规范: 项目必须使用 NVM (Node Version Manager) 来管理 Node.js 版本。这可以创建一个与系统环境（特别是 Conda）隔离的、纯净的开发环境。
操作: nvm install <version> & nvm use <version>。
包管理器:
规范: 项目必须使用 NPM 作为唯一的包管理器。
理由: 在本次调试中，pnpm 在 macOS Monterey 环境下表现出不稳定性（无法正确创建二进制文件链接），切换到 NPM 解决了此问题。
原生模块编译环境:
规范:
本地必须通过 Homebrew 安装一个兼容 node-gyp 的 Python 版本（如 python@3.11）。
项目根目录必须包含一个 .npmrc 文件，在其中明确指定 python 的可执行文件路径，以确保 electron-rebuild 能够成功编译原生依赖。
示例 (.npmrc): python=/opt/homebrew/opt/python@3.11/bin/python3.11
main 入口:
规范: main 字段必须设置为 "dist/main.js"。这个路径是 vite-plugin-electron 在 dev 模式下期望的，也是 electron-builder 在 build 模式下打包的最终入口。
build 脚本:
规范: 构建脚本已简化为 npx vite build && npx electron-builder。
理由: 移除了所有手动的 cp 和 npm install 步骤。electron-builder 会根据 build.files 配置自动、可靠地收集所需文件并处理生产依赖。
electron-builder 配置 (build 字段):
规范:
移除了 directories 配置项。
新增了 files 配置项，明确指定需要打包的文件白名单（如 dist/**/*, node_modules/**/* 等）。
理由: 这是 electron-builder 的最佳实践，可以精确控制打包内容，并解决了主进程入口文件的路径问题。
postinstall 脚本:
规范: postinstall 脚本统一使用 "npx electron-rebuild"。
理由: 事实证明，electron-rebuild 在处理本项目原生依赖时比 electron-builder install-app-deps 更直接、更稳定。
依赖版本固定:
规范: electron 的版本号已从范围 (^28.0.0) 固定为精确版本 (28.0.0)，以消除原生模块编译时的不确定性。
规范: 前端路由必须使用 HashRouter 替代 BrowserRouter。
理由: BrowserRouter 与 Electron 的 file:// 协议不兼容，会导致生产环境的应用启动后因无法匹配路由而白屏或报错。HashRouter 则能完美兼容。
7. 功能完成度与未来展望
核心架构: Electron + React + Vite + SQLite 的项目框架已完全搭建并稳定运行。
构建体系 (已重构): 建立了一套基于 NVM + NPM 的、稳定可靠的开发、编译和打包流程，能够成功构建可在 macOS 上运行的应用。
配置体系: 建立了一套健壮、解耦、单一来源的 Vite 与 TypeScript 配置体系。

##### **已完成功能**

  * **核心架构**: Electron + React + Vite + SQLite 的项目框架已完全搭建并稳定运行。
  * **配置体系**: 建立了一套健壮、解耦、单一来源的 Vite 与 TypeScript 配置体系。
  * **UI系统**: 成功整合基于MUI的自定义主题系统，建立了统一的设计语言和组件样式覆盖体系。
  * **首页/学习页**: 实现了"首页即学习"的核心理念，整合了仪表盘和课程学习内容。
  * **数据管理**: 实现了从JSON文件导入教材的完整流程。
  * **学习功能**: 情景对话、单词、语法、文章等模块均可正常展示。
  * **交互功能**: 语音朗读（全文/点读）、注音显示、悬浮高亮、点击交互均已实现。
  * **状态管理**: 记忆曲线（单词/语法）、课程完成、动态解锁、跨组件状态实时同步等高级功能已完全实现。
  * **AI助手**: 全局悬浮式AI助手已集成，并通过绝对路径调用本地 `gemini-cli`。
  * **语音识别系统**: 基于Web Speech API的发音练习功能，支持准确度评估和实时反馈，已集成到WordCard和TextReader组件。
  * **智能提醒功能**: SmartReminder组件已集成到复习页面，提供学习和复习提醒，支持优先级分类和智能调度。
  * **统一状态架构**: 创建了appStore.ts统一管理主题、布局、学习、AI助手和提醒等所有应用状态。
  * **性能优化体系**:
      * 为关键组件应用React.memo和useCallback优化，减少不必要的重渲染。
      * **通过批量IPC调用和数据库事务，显著优化了复习数据的提交性能。**
  * **仪表盘页面**: 实现了完整的学习统计仪表盘，包括词汇掌握度、语法掌握度、课程完成度等数据可视化展示。
  * **安全性增强**:
      * **移除了 `webSecurity: false` 配置，关闭了严重的安全漏洞。**
      * **修复了SQL注入风险，所有数据库查询均使用参数化查询。**

##### **待办与未来展望 (下一步)**

  * **UI统一美化**:
      * **`ReviewPage`**: "今日复习"页面目前还是旧的、朴素的样式，需要用我们新的设计语言和卡片组件进行重构。
      * **`LibraryPage` / `LessonListPage`**: 教材库和课程列表页也需要进行UI升级，使其风格与首页保持一致。
  * **功能深化**:
      * **"标记为未完成"**: 目前课程完成后，按钮会变为"已完成 ✓"，但再次点击的功能尚未实现（需要后端增加 `db:unmarkLessonAs-Complete` 接口）。
      * **仪表盘数据完善**: N5-N1课程体系的进度百分比，目前还是基于总词汇量估算，未来需要更精细的数据库查询（例如，为每个单词和语法点增加一个`level`字段）。
  * **新功能模块**:
      * **互动练习与测试**: 这是我们之前讨论过但暂时搁置的核心模块，可以作为下一个大的开发目标。放到最后实现。
      * **全局搜索/速查词典**: 增强AI助手，使其能优先在本地数据库中进行快速查询。

-----